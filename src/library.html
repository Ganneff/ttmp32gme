<script type="text/javascript">
	var getElementValues = function($id) {
		var filterVars = {};
		
		$id.find('li[class*=track_]').each( function(index) {
			var classList = $(this).attr('class').split(/\s+/);
			for (var i = 0; i < classList.length; i++) {
				if (classList[i].startsWith('track_')) {
					filterVars[classList[i]]= {
							'track': index+1,
							'title': $(this).find('input[name="title"]').val()
					};
				}
			}
		});

		$id.find('div.album-info').find('input').not(':button').each(function() {
			if ($(this).is(':checkbox')) {
				filterVars[this.name] = testCheckBox(this);
			} else {
				filterVars[this.name] = $(this).val();
			}
		});

		return filterVars;
	}

	var fillInElement = function($id, data) {
		if (data.album_artist) {
			var title = data.album_artist + ' - ' + data.album_title;
		} else {
			var title = data.album_title;
		}
		$id.find('td.filter-item span.item-title').text(title);
		$id.find('ol.track-list').empty();
		for (var i = 1; i<=data.num_tracks; i++ ) {
			var track = '<li class="track_'+i+'" style="padding: 5px 0px"><div class="input-group" style="width: 90%;">'+
				'<span class="input-group-addon duration"></span>'+
				'<input type="text" name="title" class="form-control">'+
				'<input type="hidden" name="filename">'+
				'<span class="input-group-addon"><span class="glyphicon glyphicon-resize-vertical"></span></span>'+
				'</div></li>';
			$id.find('ol.track-list').append(track);
			$id.find('ol.track-list').sortable();
			//$id.find('ol.track-list').disableSelection();
		}
		for ( var i in data) {
			if (data[i] === 'TRUE' || data[i] === 'FALSE') {
				if (data[i] === 'TRUE') {
					$id.find('input[name=' + i + ']').prop('checked', true);
					if (i !== 'enabled') {
						$id.find('input[name=' + i + ']').change();
					}
				}
			} else if (i.startsWith('track_')) {
				var $track=$id.find('li.track_'+ data[i].track);
				var ms=parseInt(data[i].duration), min = (ms/1000/60) | 0, sec = Math.round((ms/1000) % 60);
				$track.find('span.duration').text(pad(min,2)+':'+pad(sec,2));
				$track.find('input[name=title]').val(data[i].title)
				$track.find('input[name=filename]').val(data[i].filename)
			} else if (i === 'picture_filename') {
				if (data[i]) {
					$id.find('img.cover').prop('src', '/assets/images/'+data['oid']+'/'+data[i]);
				} else {
					$id.find('img.cover').prop('src', '/assets/images/not_available-generic.png');
				}
			} else {
				$id.find('input[name=' + i + ']').val(data[i]);
			}
		}
		var filenames=$id.find('input[name="filename"]').val();
	//cleanup only makes sense once we have a gme file and mp3 files in the library
		if (data.gme_file && filenames) {
			$id.find('button.cleanup').show();
		} else {
			$id.find('button.cleanup').hide();
		}
		if (data.gme_file) {
			$id.find('button.print').show();
		} else {
			$id.find('button.print').hide();
		}
		$id.find('input[name=old_oid]').val(data.oid);
		$id.find('button').each(function() {
			$(this).data('item-id', $id);
		});
		$id.find('input').data('item-id', $id);
	}
	
	function pad(n, width, z) {
	  z = z || '0';
	  n = n + '';
	  return n.length >= width ? n : new Array(width - n.length + 1).join(z) + n;
	}

	var elementCount = 0;
	
	$.urlParam = function(name){
    var results = new RegExp('[\?&]' + name + '=([^&#]*)').exec(window.location.href);
    if (results==null){
       return null;
    }
    else{
       return results[1] || 0;
    }
	}
	
	var triggerElementAction = function(action,$id,uid) {
		var filterVars = {
			'uid' : uid
		};
		$.post(
			document.baseURI,
			'action='+action+'&data=' + escape(JSON.stringify(filterVars)),
			function(data) {
				if (data.success) {
					fillInElement($id, data.element);
					notify($id.find('button.edit-button'), '', data.statusText, 'bg-success',
							2000);
				} else {
					notify($id.find('button.edit-button'), '', data.statusText, 'bg-danger',
							4000);
				}
			}, 'json').fail(function(data) {
				notify($id.find('button.edit-button'), '', 'Connection Error', 'bg-danger', 4000);
			});
	}

	var printAlbum = function(oids) {
		//expects an array of oids
		var url = "print?data=" + encodeURIComponent(JSON.stringify({'oids': oids}));
		window.open(url, '_self');
	}


	$(document).ready( function() {
		// Add tips for the new filter input
		$('[data-toggle="tooltip"]').tooltip();

		// Add event handlers for everything.  Most are delegated at the bubble-up stage.
		$('#albums').on('click', 'button.update', function() {
			updateElement($(this).data('item-id'));
			toggleShow($(this).data('item-id'));
		});
		$('#albums').on('click', 'button.make-gme', function() {
			triggerElementAction('make_gme', $(this).data('item-id'), $(this).data('item-id').find('input[name=old_oid]').val());		});
		$('#albums').on('click','button.delete',function() {
			var ok = confirm('Are you sure? This will delete the entire album including the gme file from your library. This cannot be undone.');
			if (ok) {
				deleteElement($(this).data('item-id'), $(this).data('item-id').find('input[name=old_oid]').val());
			}
		});
		$('#albums').on('click','button.cleanup',function() {
			var ok = confirm('Are you sure? This will delete all music files from this album. The gme file and the picture (if any) will remain in your library. This cannot be undone.');
			if (ok) {
				triggerElementAction('cleanup', $(this).data('item-id'), $(this).data('item-id').find('input[name=old_oid]').val());
			}
		});
		$('#albums').on('click','button.print',function() {
			printAlbum([$(this).data('item-id').find('input[name=old_oid]').val()]);
		});
		$('#albums').on('click', 'button.cancel', function() {
			toggleShow($(this).data('item-id'));
		});
		$('#albums').on('click', 'button.edit-button', function() {
			toggleShow($(this).data('item-id'));
		});

		// Grab the list of feeds, then grab the list of filters.
		listElements();
		
		if ($.urlParam('oid')) {
			toggleShow($('#albums').find('input[value="'+$.urlParam('oid')+'"]').parents('div.edit'));
		}
	});
</script>
<div class="row" id="albums">
	<div class="panel panel-default">
		<div class="panel-body">
			<table id="element-list" class="table table-striped">
				<thead>
					<tr>
						<th style="width: 99%;">Album</th>
						<th style="white-space: nowrap;">Edit</th>
					</tr>
				</thead>
				<tbody>
				</tbody>
			</table>
		</div>
	</div>
</div>
<table style="display: none;">
	<tr id="element-template" style="display: none;">
		<td class="filter-item"><span class="item-title"></span>
			<div class="panel panel-default edit" style="display: none;">
				<div class="panel-heading">
					<h4 class="panel-title">Edit album:</h4>
				</div>
				<div class="panel-body">
					<div class="row" style="padding-bottom: 15px;">
						<div class="col-sm-12">
							<div class="btn-group" role="group"
								aria-label="save cancel delete button group">
								<button type="button" class="btn btn-primary update">Update</button>
								<button type="button" class="btn btn-success make-gme">Create GME</button>
								<button type="button" class="btn btn-success print" style="display: none;">Print</button>
								<button type="button" class="btn btn-warning cleanup" style="display: none;">CleanUp</button>
								<button type="button" class="btn btn-danger delete">Delete</button>
								<button type="button" class="btn btn-info cancel">Cancel</button>
							</div>
						</div>
					</div>
					<div class="row">
						<div class="col-sm-6 album-info">
							<img class="img-responsive cover" alt="cover">
							<div class="form-group">
								<label for="title">OID:</label> <input type="text" name="oid"
									class="form-control"><input type="hidden" name="old_oid">
							</div>
							<div class="form-group">
								<label for="title">Album title:</label> <input type="text" name="album_title"
									class="form-control">
							</div>
							<div class="form-group">
								<label for="title">Album artist:</label> <input type="text"
									name="album_artist" class="form-control">
							</div>
							<div class="form-group">
								<label for="title">Album year:</label> <input type="text" name="album_year"
									class="form-control">
							</div>
							<div class="form-group">
								<label for="title">GME file:</label> <input type="text" name="gme_file"
									class="form-control" disabled>
							</div>
							<div class="form-group">
								<label for="title">Path:</label> <input type="text" name="path"
									class="form-control" disabled>
							</div>
						</div>
						<div class="col-sm-6">
							<div class="form-inline">
								<label>Tracks (drag &amp; drop to change order):</label>
								<ol class="track-list"></ol>
							</div>
						</div>
					</div>
				</div>
			</div></td>
		<td>
			<button type="button" class="btn btn-info btn-xs hidden-xs edit-button"
				data-placement="top">Edit</button>
			<button type="button" class="btn btn-info visible-xs-block edit-button"
				data-placement="top">Edit</button>
		</td>
	</tr>
</table>
